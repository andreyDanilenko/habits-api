# История привычек и календарь

Этот документ описывает, как бекенд хранит историю изменений привычек и как это влияет на поведение календаря.

## Основные сущности

- `habits` — текущие привычки пользователя (актуальное состояние).
- `habit_completions` — факты выполнения привычек по датам.
- `habit_versions` — версии привычек во времени для исторического календаря.

### Таблица `habit_versions`

Таблица `habit_versions` хранит снимки (версии) привычек на определённые интервалы дат:

- `habit_id`, `user_id`, `workspace_id` — привязка к привычке и рабочему пространству.
- `title`, `description`, `color`, `icon` — отображаемые поля.
- `target_days`, `daily_goal`, `preferred_time`, `category` — метаданные цели.
- `schedule_type`, `recurring_days`, `one_time_date`, `is_active` — расписание и активность.
- `valid_from`, `valid_to` — диапазон дат (включительно), в течение которого эта версия считается актуальной.

На одну привычку может быть несколько версий, покрывающих разные промежутки времени.

### Таблица `habit_completions`

К таблице `habit_completions` добавлено поле:

- `workspace_id` — позволяет фильтровать выполнения по рабочему пространству без JOIN с `habits`.

Старые записи заполняются через миграцию с помощью `habits.workspace_id`.

## Поведение при операциях с привычками

### Создание привычки

При создании привычки:

1. Запись создаётся в таблице `habits`.
2. Для неё создаётся стартовая версия в `habit_versions`:
   - `valid_from` = дата создания (без времени).
   - `valid_to` = `NULL` (версия считается «открытой»).

### Обновление привычки

При изменении ключевых полей (`title`, `description`, `color`, `icon`, расписания и активности):

1. Обновляется запись в `habits`.
2. Текущая открытая версия в `habit_versions` закрывается:
   - `valid_to` = день перед датой изменения.
3. Создаётся новая версия с обновлёнными полями:
   - `valid_from` = дата изменения.
   - `valid_to` = `NULL`.

Таким образом:

- Все **прошлые дни** используют старое название/описание.
- Начиная с даты изменения и дальше используется новое название/описание.

### Удаление привычки

При удалении привычки:

1. Внутри транзакции читается `workspace_id` из `habits`.
2. В `habit_versions` закрывается текущая открытая версия:
   - `valid_to` = дата удаления.
3. Запись из `habits` удаляется.

Важные моменты:

- **Записи в `habit_completions` не удаляются.** История выполнений сохраняется.
- Календарь больше не будет показывать эту привычку на даты **после** удаления, но:
  - Все **прошлые дни** (до и включая дату удаления) продолжают отображать привычку согласно существующим версиям.

## Как строится календарь

### Активные привычки на дату

Метод `GetHabitsForDate` использует `habit_versions`:

- Фильтр по пользователю и рабочему пространству.
- Фильтр по интервалу дат:
  - `targetDate BETWEEN valid_from AND COALESCE(valid_to, targetDate)`.
- Фильтр по расписанию:
  - Для `schedule_type = 'recurring'` проверяется день недели в `recurring_days`.
  - Для `schedule_type = 'one_time'` проверяется совпадение с `one_time_date`.

Результат: на любую дату мы получаем **список привычек с теми полями (названием, описанием, цветом и т.д.), которые были актуальны именно в этот день**.

### Выполнения (completions)

Метод `GetCalendar`:

1. Читает все выполнения из `habit_completions` за указанный период по `user_id` и `workspace_id`.
2. Для каждой даты в интервале:
   - Получает активные на эту дату привычки через `GetHabitsForDate`.
   - Помечает каждую привычку флагом `Completed`, если в `habit_completions` есть запись для этой даты и `habit_id`.

Важно:

- Календарь показывает **все запланированные дни** по расписанию (а не только дни с выполнениями).
- Даже если привычка была удалена позже, она остаётся в календаре за прошлые дни.

## Итоговое поведение для пользователя

1. **Удаление привычки**
   - Прошлые дни в календаре продолжают показывать эту привычку (с отметками выполнено/не выполнено), согласно расписанию и историческим версиям.
   - Начиная с даты удаления новые дни для этой привычки в календаре больше не создаются.

2. **Переименование/изменение описания**
   - Все дни **до даты изменения** показывают старое название и описание.
   - Начиная с **даты изменения** и далее календарь показывает новое название и описание.

3. **Фронтенд**
   - Использует API календаря, которое возвращает уже «исторически корректные» названия и статусы.
   - При необходимости фронтенд может обогащать карточки дополнительными полями из текущего списка привычек (`/habits`), не ломая историю.

